version: '3.3'
services:
  postgres:
    image: postgres:17
    environment:
      POSTGRES_DB: ApplyStatusDB
      POSTGRES_USER: user01
      POSTGRES_PASSWORD: P@ssw0rd
    ports:
      - "0.0.0.0:5435:5432"
    volumes:
      - ./init-scripts:/docker-entrypoint-initdb.d

  message-broker:
    container_name: message-broker
    image: nats:2.10
    ports:
      - "4222:4222"
    command: ["-js",  "-c", "/server.conf" ] 
    volumes:
      - "./message-broker/server.conf:/server.conf"
      - message-broker:/data/nats/jetstream

  message-broker-init:
    image: natsio/nats-box:latest
    depends_on:
      - message-broker
    command: >
      nats stream add layout_apply_apply --subjects=layout_apply_apply.completed --server=nats://message-broker:4222 --storage=file --retention=limits --max-msgs=-1 --max-bytes=-1 --max-age=0s --dupe-window=2m --defaults

  dapr:
    image: daprio/daprd:edge
    command: [ "./daprd", "-app-id", "cdim-layout-apply", "-app-port", "8003", "-dapr-http-port", "3500", "-placement-host-address", "placement:50006", "-config", "/configuration/config.yaml", "-resources-path", "/components" ]
    ports:
      - "0.0.0.0:3500:3500"
    volumes:
      - "./components/:/components"
      - "./configuration/:/configuration"
      - "./secrets/:/secrets"
    depends_on:
      - message-broker

volumes:
  message-broker: